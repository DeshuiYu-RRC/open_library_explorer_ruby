<!-- Feature 3.2 - Member Pages -->
<!-- Feature 3.3 - Multi-model Data on Member Pages -->

<div class="row mb-4">
  <div class="col-md-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><%= link_to "Home", root_path %></li>
        <li class="breadcrumb-item"><%= link_to "Books", books_path %></li>
        <li class="breadcrumb-item active"><%= @book.title.truncate(50) %></li>
      </ol>
    </nav>
  </div>
</div>

<div class="row">
  <!-- Book Cover -->
  <div class="col-md-4">
    <%= image_tag @book.cover_image_url('L'),
                  alt: @book.title,
                  class: "img-fluid book-cover rounded" %>

    <div class="card mt-3">
      <div class="card-body">
        <h6 class="card-title">Book Details</h6>

        <% if @book.first_publish_year.present? %>
          <p class="mb-2">
            <strong>Published:</strong> <%= @book.first_publish_year %>
          </p>
        <% end %>

        <% if @book.page_count.present? %>
          <p class="mb-2">
            <strong>Pages:</strong> <%= @book.page_count %>
          </p>
        <% end %>

        <% if @book.isbn.present? %>
          <p class="mb-2">
            <strong>ISBN:</strong> <%= @book.isbn %>
          </p>
        <% end %>

        <p class="mb-0">
          <strong>Average Rating:</strong><br>
          <span class="star-rating fs-5">
            <%= '⭐' * @book.average_rating.round %>
          </span>
          <small class="text-muted">
            <%= @book.average_rating %> / 5.0
            (<%= @book.reviews.count %> reviews)
          </small>
        </p>
      </div>
    </div>
  </div>

  <!-- Book Information -->
  <div class="col-md-8">
    <h1><%= @book.title %></h1>

    <!-- Authors (Feature 3.3) -->
    <h5 class="text-muted mb-3">
      <% if @book.authors.any? %>
        by
        <% @book.authors.each_with_index do |author, index| %>
          <%= link_to author.name, author_path(author), class: "text-decoration-none" %><%= ', ' unless index == @book.authors.size - 1 %>
        <% end %>
      <% else %>
        Unknown Author
      <% end %>
    </h5>

    <!-- Subjects (Feature 3.3 & 3.4) -->
    <div class="mb-3">
      <strong>Subjects:</strong><br>
      <% if @book.subjects.any? %>
        <% @book.subjects.limit(15).each do |subject| %>
          <%= link_to subject.name, subject_path(subject),
                      class: "badge bg-secondary subject-badge text-decoration-none" %>
        <% end %>
      <% else %>
        <span class="text-muted">No subjects listed</span>
      <% end %>
    </div>

    <!-- Description -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Description</h5>
        <% if @book.description.present? %>
          <p class="card-text"><%= simple_format(@book.description) %></p>
        <% else %>
          <p class="card-text text-muted">No description available.</p>
        <% end %>
      </div>
    </div>

    <!-- Reviews (Feature 3.3) -->
    <h3 class="mt-4">Reader Reviews</h3>

    <% if @book.reviews.any? %>
      <% @book.reviews.order(review_date: :desc).limit(10).each do |review| %>
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="card-subtitle mb-2">
                  <%= review.reviewer_name %>
                  <span class="star-rating ms-2">
                    <%= '⭐' * review.rating %>
                  </span>
                </h6>
              </div>
              <small class="text-muted">
                <%= review.review_date.strftime("%B %d, %Y") %>
              </small>
            </div>
            <p class="card-text mt-2"><%= review.comment %></p>
          </div>
        </div>
      <% end %>

      <% if @book.reviews.count > 10 %>
        <p class="text-muted">
          Showing 10 of <%= @book.reviews.count %> reviews
        </p>
      <% end %>
    <% else %>
      <p class="text-muted">No reviews yet.</p>
    <% end %>

    <!-- Related Books (Feature 3.4) -->
    <% if @related_books.any? %>
      <h3 class="mt-5">Related Books</h3>
      <div class="row">
        <% @related_books.each do |related_book| %>
          <div class="col-md-4 col-sm-6 mb-3">
            <div class="card h-100">
              <%= link_to book_path(related_book) do %>
                <%= image_tag related_book.cover_image_url('S'),
                              alt: related_book.title,
                              class: "card-img-top",
                              style: "height: 200px; object-fit: cover;" %>
              <% end %>
              <div class="card-body">
                <h6 class="card-title">
                  <%= link_to related_book.title.truncate(40),
                              book_path(related_book),
                              class: "text-decoration-none" %>
                </h6>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>